name: Security Scan

on:
  workflow_call:
    inputs:
      node_version:
        required: true
        type: string

jobs:
  security:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/frontend
    permissions:
      contents: read
      security-events: write
    steps:
    - uses: actions/checkout@v4

    - uses: pnpm/action-setup@v4
      with:
        version: 10

    - uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
        cache: pnpm
        cache-dependency-path: src/frontend/pnpm-lock.yaml

    - name: Install frontend deps
      run: pnpm install --frozen-lockfile

    - name: Run pnpm audit
      run: pnpm audit --audit-level=moderate | tee pnpm-audit.txt
      continue-on-error: true

    - uses: actions/setup-dotnet@v4
      with:
        global-json-file: global.json

    - name: Run .NET security scan
      working-directory: src/apphost/Aspire.Dev.AppHost
      run: dotnet list package --vulnerable --include-transitive | tee ../../../src/frontend/dotnet-vulnerabilities.txt
      continue-on-error: true

    - name: Trivy filesystem vulnerability scan (SARIF)
      uses: aquasecurity/trivy-action@0.24.0
      with:
        scan-type: fs
        format: sarif
        output: trivy-results.sarif
        severity: CRITICAL,HIGH,MEDIUM
        ignore-unfixed: true
        vuln-type: os,library
        scan-ref: .
      continue-on-error: true

    - name: Upload SARIF to GitHub code scanning
      if: ${{ always() }}
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results.sarif

    - name: Upload security scan artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          trivy-results.sarif
          src/frontend/pnpm-audit.txt
          src/frontend/dotnet-vulnerabilities.txt
        if-no-files-found: warn
        retention-days: 7
